name: Download Books

on:
  workflow_dispatch:
    inputs:
      search_terms:
        description: 'Search terms separated by commas (e.g., "1984 orwell, dune herbert")'
        required: true
        type: string

jobs:
  download:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Create downloads directory
        run: mkdir -p downloads
      
      - name: Parse search terms
        run: |
          echo "=== Parsing search terms ==="
          echo '${{ github.event.inputs.search_terms }}' | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | grep -v '^$' > search_terms.txt
          cat -n search_terms.txt
      
      - name: Download books via libgen-downloader
        run: |
          echo "=== Installing libgen-downloader ==="
          npm install -g libgen-downloader
          
          echo ""
          echo "=== Downloading books ==="
          
          while IFS= read -r term; do
            echo ""
            echo "========================================"
            echo "Searching: $term"
            echo "========================================"
            
            # libgen-downloader search and download
            # Use timeout to prevent hanging on interactive prompts
            # -d downloads the first result automatically
            timeout 120 libgen-downloader -s "$term" -d || echo "FAILED or TIMEOUT: $term"
            
            # Wait between searches
            sleep 3
          done < search_terms.txt
          
          # Move any downloaded files to downloads folder
          echo ""
          echo "=== Moving downloaded files ==="
          mv *.pdf downloads/ 2>/dev/null || true
          mv *.epub downloads/ 2>/dev/null || true
          mv *.mobi downloads/ 2>/dev/null || true
          find . -maxdepth 1 -type f \( -name "*.pdf" -o -name "*.epub" -o -name "*.mobi" \) -exec mv {} downloads/ \; 2>/dev/null || true
      
      - name: List downloaded files
        run: |
          echo "=== Downloaded Files ==="
          ls -lah downloads/ 2>/dev/null || echo "No files"
          echo ""
          echo "=== File count ==="
          find downloads/ -type f 2>/dev/null | wc -l
      
      - name: Upload downloads as artifact
        uses: actions/upload-artifact@v4
        with:
          name: downloaded-books
          path: downloads/
          retention-days: 7
          if-no-files-found: warn
